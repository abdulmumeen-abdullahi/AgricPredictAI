# -*- coding: utf-8 -*-
"""Crop_Yield_Prediction

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1NpA23k8u_hHl3Mn6smWNwZukVK2Qh8H3
"""

import streamlit as st
import pickle
import numpy as np
import os
import gdown
import openai

st.set_page_config(page_title="Crop Yield Prediction", layout="centered")

# --- Load model from Google Drive if not present ---
file_id = "1QXq2c3Gl2SjK1dM7bIOCvXSxK0hbVXnS"
model_url = f"https://drive.google.com/uc?id={file_id}"
model_path = "crop_yield_best_random_model.pkl"


@st.cache_resource
def load_model():
    if not os.path.exists(model_path):
        with st.spinner("Downloading crop yield model..."):
            gdown.download(model_url, model_path, quiet=False)
    with open(model_path, "rb") as f:
        return pickle.load(f)

try:
    model = load_model()
except Exception as e:
    st.error(f"üö´ Could not load model. Try again later.\n\nError: {e}")
    st.stop()

# --- UI Input Fields ---
st.title("Crop Yield Prediction")
st.write("Estimate the yield of major crops using soil, weather, and nutrient inputs.")

crop_type = st.selectbox("Crop Type", ["Corn", "Potato", "Rice", "Sugarcane", "Wheat"])
soil_type = st.selectbox("Soil Type", ["Clay", "Loamy", "Peaty", "Saline", "Sandy"])
soil_ph = st.number_input("Soil pH", min_value=0.0, max_value=14.0, value=6.5)
temperature = st.slider("Temperature (¬∞C)", 10, 40, 25)
humidity = st.slider("Humidity (%)", 0, 100, 50)
wind_speed = st.slider("Wind Speed (km/h)", 0, 100, 15)
n = st.number_input("Nitrogen (N)", min_value=0, value=60)
p = st.number_input("Phosphorus (P)", min_value=0, value=45)
k = st.number_input("Potassium (K)", min_value=0, value=31)
soil_quality = st.number_input("Soil Quality (0‚Äì100)", min_value=0, max_value=100, value=50)

# Encode categories
crop_encoded = {"Corn": 0, "Potato": 1, "Rice": 2, "Sugarcane": 3, "Wheat": 4}[crop_type]
soil_encoded = {"Clay": 0, "Loamy": 1, "Peaty": 2, "Saline": 3, "Sandy": 4}[soil_type]

input_features = np.array([[crop_encoded, soil_encoded, soil_ph, temperature, humidity, wind_speed, n, p, k, soil_quality]])

# --- Prediction & GPT-based Advice ---
if st.button("Predict Yield"):
    prediction = model.predict(input_features)
    st.success(f"Predicted Crop Yield: **{prediction[0]:.2f} tons/hectare**")

    st.subheader("AI Yield Analysis")
    openai.api_key = st.secrets["OPENAI_API_KEY"]

    yield_prompt = (
        f"A farmer provided the following conditions for {crop_type} crop:\n"
        f"- Soil Type: {soil_type}\n"
        f"- Soil pH: {soil_ph}\n"
        f"- Temperature: {temperature}¬∞C\n"
        f"- Humidity: {humidity}%\n"
        f"- Wind Speed: {wind_speed} km/h\n"
        f"- N: {n}, P: {p}, K: {k}\n"
        f"- Soil Quality Score: {soil_quality}/100\n"
        f"The predicted yield is {prediction[0]:.2f} tons/hectare.\n"
        f"Act like a Nigerian agricultural assistant and give easy-to-understand expert advice on this yield and how to improve it."
    )

    with st.spinner("Asking AgriGPT..."):
        response = openai.ChatCompletion.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "You are an AI agricultural assistant helping Nigerian farmers."},
                {"role": "user", "content": yield_prompt}
            ],
            temperature=0.7,
            max_tokens=500
        )

        st.info(response.choices[0].message["content"])


st.markdown("---")
st.caption("Powered by EfficientNet + Scikit-Learn + GPT-3.5 | Built with ‚ù§Ô∏è for Nigerian farmers üá≥üá¨")